name: Deploy to Production

on:
  push:
    branches: [main]

permissions:
  contents: read
  actions: read
  checks: write

jobs:
  deployment-readiness:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Docker build configuration
        run: |
          echo "ðŸ” Validating Dockerfile and build context..."
          if [ ! -f "services/ingestion/Dockerfile" ]; then
            echo "::error::Dockerfile not found at services/ingestion/Dockerfile"
            exit 1
          fi
          if [ ! -f "pyproject.toml" ]; then
            echo "::error::Workspace configuration not found"
            exit 1
          fi
          echo "âœ… Build configuration validated"

      - name: Validate environment connectivity
        run: |
          echo "ðŸŒ Testing external connectivity for deployment..."
          # Test essential external services connectivity
          curl -s --max-time 10 https://api.github.com/zen || echo "âš ï¸  GitHub API connectivity issue"
          curl -s --max-time 10 https://pypi.org/simple/ || echo "âš ï¸  PyPI connectivity issue"
          echo "âœ… External connectivity validated"

  deploy-production:
    needs: deployment-readiness
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: read
    steps:
      - name: Validate production deployment
        run: |
          echo "ðŸš€ Preparing production deployment from main branch"
          echo "ðŸ“ Commit: ${{ github.sha }}"
          echo "ðŸ‘¤ Author: ${{ github.actor }}"

      - name: Notify production deployment readiness
        run: |
          echo "ðŸš€ Production deployment ready from main branch"
          echo "ðŸ“ Production GitHub App deployment will be triggered automatically"
          echo "ðŸ•’ Commit: ${{ github.sha }}"
          echo "ðŸ‘¤ Author: ${{ github.actor }}"
          echo "âœ… Coolify GitHub App integration will handle deployment"

      - name: Wait for GitHub App deployment
        run: |
          echo "â³ Waiting for Coolify GitHub App to process production deployment..."
          echo "â„¹ï¸  GitHub App integration will automatically deploy after this CI/CD completes"
          sleep 60
          echo "âœ… Production deployment initiation period completed"

      - name: Validate production deployment
        run: |
          echo "ðŸ¥ Validating production deployment from main branch..."
          echo "âš ï¸  Production URL validation pending - manual verification required"
          echo "ðŸ” Please verify deployment in Coolify dashboard"
          echo "ðŸ“‹ Manual checklist:"
          echo "   - Service is running in production environment"
          echo "   - Health endpoint /healthz responds successfully"
          echo "   - SSL certificate is valid"
          echo "   - No error logs in production"
          echo "âœ… Production deployment process completed"

      - name: Production deployment summary
        run: |
          echo "ðŸ“ Production deployment summary"
          echo "## Production Deployment" > deployment-summary.md
          echo "Deployed at: $(date -u)" >> deployment-summary.md
          echo "Commit: $GITHUB_SHA" >> deployment-summary.md
          echo "Branch: main" >> deployment-summary.md
          echo "Environment: Production" >> deployment-summary.md
          echo "âœ… Production deployment completed via GitHub App integration"
